import { auth } from "./firebase.js";
import { onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
import { 
  getFirestore, doc, getDoc, updateDoc, arrayUnion, arrayRemove,
  collection, addDoc, serverTimestamp, onSnapshot, query, orderBy
} from "https://www.gstatic.com/firebasejs/10.8.0/firebase-firestore.js";

const db = getFirestore();
let currentChatUid = null;
let unsubscribeChat = null;

// Ждем полной загрузки HTML, прежде чем вешать события
document.addEventListener("DOMContentLoaded", () => {
    console.log("Xenocord: Скрипт инициализирован");

    // --- Кнопка Выхода ---
    const logoutBtn = document.getElementById("logoutBtn");
    if (logoutBtn) {
        logoutBtn.onclick = () => {
            console.log("Нажата кнопка выхода");
            signOut(auth).then(() => window.location.href = "index.html");
        };
    }

    // --- Модалка добавления друга ---
    const addFriendBtn = document.getElementById("addFriendBtn");
    if (addFriendBtn) {
        addFriendBtn.onclick = () => {
            console.log("Открываем модалку");
            document.getElementById("friendModal").style.display = "block";
        };
    }

    // --- Отправка запроса ---
    const confirmBtn = document.getElementById("confirmSendRequest");
    if (confirmBtn) {
        confirmBtn.onclick = async () => {
            const fUid = document.getElementById("friendUidInput").value.trim();
            console.log("Пытаемся добавить UID:", fUid);
            if (!fUid || fUid === auth.currentUser.uid) return alert("Неверный UID");
            
            try {
                const friendRef = doc(db, "users", fUid);
                await updateDoc(friendRef, { pending: arrayUnion(auth.currentUser.uid) });
                alert("Запрос отправлен!");
                document.getElementById("friendModal").style.display = "none";
            } catch (e) {
                console.error("Ошибка при добавлении:", e);
                alert("Пользователь не найден или ошибка доступа");
            }
        };
    }

    // --- Отправка сообщения ---
    const sendMsgBtn = document.getElementById("sendMsgBtn");
    if (sendMsgBtn) {
        sendMsgBtn.onclick = sendMessage;
    }
});

// --- Логика Firebase остается вне DOMContentLoaded для скорости ---
onAuthStateChanged(auth, async user => {
    if (!user) {
        if (!window.location.pathname.includes("index.html")) {
            window.location.href = "index.html";
        }
    } else {
        console.log("Авторизован как:", user.email);
        const nickEl = document.getElementById("userNick");
        if (nickEl) nickEl.innerText = user.email.split('@')[0];
        
        const uidEl = document.getElementById("userUid");
        if (uidEl) uidEl.innerText = user.uid;

        loadFriendsData(user.uid);
    }
});

async function sendMessage() {
    const input = document.getElementById("chatInput");
    console.log("Пытаемся отправить:", input.value);
    if (!input.value || !currentChatUid) return;

    const chatId = [auth.currentUser.uid, currentChatUid].sort().join("_");
    try {
        await addDoc(collection(db, "privateMessages", chatId, "messages"), {
            senderUid: auth.currentUser.uid,
            text: input.value,
            timestamp: serverTimestamp()
        });
        input.value = "";
    } catch (e) {
        console.error("Ошибка отправки сообщения:", e);
    }
}

// Функции рендера (loadFriendsData, openChat и т.д.) остаются такими же, как в прошлом шаге
// Но убедись, что они определены как обычные функции в этом файле.
